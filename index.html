<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AQUARIUS AI - IMMERSIVE OS v9.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet" />
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <!-- Tone.js for Sound Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        :root {
            --retro-green: #33ff33;
            --dark-bg: #0a0a0a;
        }
        body {
            font-family: 'VT323', monospace;
            background-color: var(--dark-bg);
            color: var(--retro-green);
            text-shadow: 0 0 5px rgba(51, 255, 51, 0.5);
            overflow: hidden;
        }
        #starfield-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
        }
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            background: linear-gradient(to bottom, rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px;
            animation: scan 0.1s linear infinite;
            z-index: 9999;
        }
        .crt-effect {
            box-shadow: 0 0 25px rgba(51, 255, 51, 0.3), inset 0 0 25px rgba(51, 255, 51, 0.2);
            border-radius: 20px;
            animation: flicker 0.15s infinite;
        }
        .retro-input, .retro-textarea {
            background-color: transparent; border: 1px solid var(--retro-green); border-radius: 0;
            color: var(--retro-green); padding: 8px; outline: none; resize: none;
        }
        .retro-input:focus, .retro-textarea:focus {
            background-color: rgba(51, 255, 51, 0.1); box-shadow: 0 0 8px var(--retro-green);
        }
        .retro-button {
            background-color: transparent; border: 1px solid var(--retro-green); color: var(--retro-green);
            padding: 10px 15px; border-radius: 0; transition: all 0.2s; cursor: pointer;
        }
        .retro-button:hover:not(:disabled) {
            background-color: var(--retro-green); color: var(--dark-bg); text-shadow: none;
        }
        .retro-button:disabled { opacity: 0.4; cursor: not-allowed; }
        .retro-container { background-color: rgba(0,0,0,0.8); border: 1px solid var(--retro-green); }
        .retro-header { border-bottom: 1px solid var(--retro-green); padding: 0.75rem; text-transform: uppercase; }
        .glitch-text { animation: glitch 1.5s linear infinite; }
        .typing-cursor {
            display: inline-block; width: 10px; height: 1.2em;
            background-color: var(--retro-green);
            animation: blink-caret 1s step-end infinite; vertical-align: bottom;
        }
        .blessing-glow {
             animation: glowing-blessing 2s ease-in-out infinite;
        }
        .red-alert-flash {
            animation: red-flash 0.8s infinite;
        }
        
        @keyframes scan { 0% { background-position: 0 0; } 100% { background-position: 0 4px; } }
        @keyframes glitch { 2%,64%{ transform: translate(2px,0) skew(0deg); } 4%,60%{ transform: translate(-2px,0) skew(0deg); } 62%{ transform: translate(0,0) skew(5deg); } }
        @keyframes blink-caret { from, to { background-color: transparent; } 50% { background-color: var(--retro-green); } }
        @keyframes flicker { 0% { opacity: 1; } 50% { opacity: 0.98; } 100% { opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes glowing-blessing {
            0% { box-shadow: 0 0 5px var(--retro-green); }
            50% { box-shadow: 0 0 20px var(--retro-green), 0 0 25px var(--retro-green); }
            100% { box-shadow: 0 0 5px var(--retro-green); }
        }
        @keyframes red-flash {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
            50% { box-shadow: 0 0 50px 30px rgba(255, 0, 0, 0.7), inset 0 0 30px rgba(255,0,0,0.6); }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div class="scanlines"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- REAL FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCHDzGbXmHNWKL2UtRm57vPRVxZb31dHto",
            authDomain: "long-bao-tool-ai.firebaseapp.com",
            projectId: "long-bao-tool-ai",
            storageBucket: "long-bao-tool-ai.appspot.com",
            messagingSenderId: "259613170671",
            appId: "1:259613170671:web:55291d0b0af4e69052b41a",
            measurementId: "G-7V7H3JWX7K"
        };
        const ADMIN_USERNAME = "admin";
        const DUMMY_DOMAIN = "@long-bao-tool-ai.web.app";

        // --- FIREBASE INIT ---
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // --- GAME DATA ---
        const BACARAT_TABLES = ["BACARAT C04", "BACARAT C05", "BACARAT C06", "BACARAT C07", "BACARAT C01", "BACARAT C02", "BACARAT C03", "BACARAT C08", "BACARAT C09", "BACARAT C10", "BACARAT 1", "BACARAT 2", "BACARAT 3", "BACARAT 4", "BACARAT 5", "BACARAT 7", "BACARAT 8", "BACARAT 9", "BACARAT 10", "BACARAT C11", "BACARAT C12", "BACARAT C13", "BACARAT C15"];
        const COOLDOWN_DURATION = 24 * 60 * 60 * 1000;
        const MESSAGE_COST = 7;

        // --- SOUND SERVICE ---
        const soundService = {
            isStarted: false, synth: null, noise: null, ambient: null,
            init() {
                if (this.isStarted || typeof Tone === 'undefined') return;
                this.synth = new Tone.Synth().toDestination();
                this.noise = new Tone.NoiseSynth({ volume: -20 }).toDestination();
                this.ambient = new Tone.Noise("brown").toDestination();
                this.ambient.volume.value = -40;
                this.isStarted = true;
            },
            startAmbient() { if(this.ambient && this.ambient.state !== 'started') this.ambient.start(); },
            stopAmbient() { if(this.ambient) this.ambient.stop(); },
            playClick() { this.synth?.triggerAttackRelease("C2", "8n"); },
            playSend() { this.synth?.triggerAttackRelease("G4", "8n"); },
            playReceive() { this.synth?.triggerAttackRelease("C5", "8n"); },
            playError() { this.noise?.triggerAttackRelease("2n"); },
            playTyping() { this.synth?.triggerAttackRelease("C3", "32n"); },
            playAlert() {
                 if (!this.isStarted) this.init();
                 const synth = new Tone.Synth({
                    oscillator: { type: 'square' },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 }
                }).toDestination();
                synth.triggerAttackRelease('G5', '8n', Tone.now());
                synth.triggerAttackRelease('G5', '8n', Tone.now() + 0.2);
            }
        };

        //================================================================================
        // COMPONENT: Starfield
        //================================================================================
        const Starfield = () => {
            const canvasRef = useRef(null);
            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let stars = [];
                const numStars = 300;
                let animationFrameId;

                const resizeCanvas = () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                    stars = [];
                    for (let i = 0; i < numStars; i++) {
                        stars.push({
                            x: Math.random() * canvas.width,
                            y: Math.random() * canvas.height,
                            size: Math.random() * 1.5,
                            speed: Math.random() * 0.5 + 0.1
                        });
                    }
                };

                const animate = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = 'rgba(51, 255, 51, 0.8)';
                    stars.forEach(star => {
                        star.y += star.speed;
                        if (star.y > canvas.height) {
                            star.y = 0;
                            star.x = Math.random() * canvas.width;
                        }
                        ctx.beginPath();
                        ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                        ctx.fill();
                    });
                    animationFrameId = requestAnimationFrame(animate);
                };

                resizeCanvas();
                animate();
                window.addEventListener('resize', resizeCanvas);
                return () => {
                    window.removeEventListener('resize', resizeCanvas);
                    cancelAnimationFrame(animationFrameId);
                }
            }, []);
            return <canvas id="starfield-canvas" ref={canvasRef}></canvas>;
        };

        //================================================================================
        // COMPONENT: TypingMessage
        //================================================================================
        const TypingMessage = ({ text, onComplete }) => {
            const [displayedText, setDisplayedText] = useState('');
            useEffect(() => {
                setDisplayedText('');
                let index = 0;
                const intervalId = setInterval(() => {
                    soundService.playTyping();
                    setDisplayedText(prev => prev + text.charAt(index));
                    index++;
                    if (index >= text.length) {
                        clearInterval(intervalId);
                        if(onComplete) onComplete();
                    }
                }, 50);
                return () => clearInterval(intervalId);
            }, [text]);
            return <p>{displayedText}<span className="typing-cursor"></span></p>;
        };
        
        //================================================================================
        // COMPONENT: MessageContent
        //================================================================================
        const MessageContent = ({ msg }) => {
            switch(msg.type) {
                case 'system': return <p className="text-yellow-300 w-full text-center">{msg.text}</p>;
                case 'plea': return <p className="opacity-80 italic">Lời thỉnh cầu: "{msg.text}"</p>;
                case 'blessing': return (
                    <div className="border border-green-700 p-2 mt-1 blessing-glow">
                        <p className="glitch-text text-center text-lg">LỜI BAN PHƯỚC</p>
                        <p>> BÀN CHƠI: {msg.content.table}</p>
                        <p>> KẾT QUẢ DỰ ĐOÁN: {msg.content.side}</p>
                        <p>> TAY BÀI THỨ: {msg.content.hand}</p>
                    </div>
                );
                case 'info_submission': return (
                    <div className="border border-cyan-700 p-2 mt-1">
                        <p className="glitch-text text-center text-lg text-cyan-400">BÁO CÁO KHỞI TẠO</p>
                        <p>> TÀI KHOẢN F168: {msg.content.f168Account}</p>
                        <p>> SỐ VỐN: {msg.content.capital}</p>
                        <p>> MỤC TIÊU: {msg.content.target}</p>
                    </div>
                );
                default: return <p>{msg.text}</p>;
            }
        };
        
        //================================================================================
        // COMPONENT: LoginScreen
        //================================================================================
        const LoginScreen = () => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [booting, setBooting] = useState(true);
            const [bootLines, setBootLines] = useState([]);

            useEffect(() => {
                const bootSequence = [
                    'AQUARIUS OS v9.3 INITIALIZING...',
                    'CHECKING MEMORY... OK',
                    'LOADING CORE MODULES... OK',
                    'ESTABLISHING FIREBASE CONNECTION... SECURE',
                    'AWAITING PILOT AUTHENTICATION...'
                ];
                let index = 0;
                const interval = setInterval(() => {
                    soundService.playTyping();
                    setBootLines(prev => [...prev, bootSequence[index]]);
                    index++;
                    if (index >= bootSequence.length) {
                        clearInterval(interval);
                        setTimeout(() => setBooting(false), 500);
                    }
                }, 600);
                return () => clearInterval(interval);
            }, []);

            const handleLogin = async () => {
                setError(''); setIsLoading(true);
                const processedUsername = username.trim().toLowerCase();
                if (!processedUsername || !password) { setError("LỖI: THIẾU TÍN HIỆU"); setIsLoading(false); return; }
                const email = processedUsername + DUMMY_DOMAIN;
                try { await auth.signInWithEmailAndPassword(email, password); } 
                catch (err) { setError("LỖI: XÁC THỰC THẤT BẠI"); } 
                finally { setIsLoading(false); }
            };
            
            const handleSignup = async () => {
                setError(''); setIsLoading(true);
                const processedUsername = username.trim().toLowerCase();
                if (!processedUsername || !password) { setError("LỖI: THIẾU TÍN HIỆU"); setIsLoading(false); return; }
                if (password.length < 6) { setError("LỖI: MẬT KHẨU QUÁ NGẮN (TỐI THIỂU 6 KÝ TỰ)"); setIsLoading(false); return; }
                
                try {
                    const usersRef = db.collection("users");
                    const existingUserQuery = await usersRef.where("username", "==", processedUsername).get();
                    if (!existingUserQuery.empty) {
                        setError("LỖI: MÃ HIỆU PILOT ĐÃ TỒN TẠI");
                        setIsLoading(false);
                        return;
                    }

                    const email = processedUsername + DUMMY_DOMAIN;
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await db.collection("users").doc(userCredential.user.uid).set({
                        uid: userCredential.user.uid,
                        username: processedUsername,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        energy: 7,
                        hasSubmittedInfo: false,
                    }, { merge: true });
                } catch (err) {
                    if (err.code === 'auth/email-already-in-use') { setError("LỖI: MÃ HIỆU PILOT ĐÃ TỒN TẠI"); } 
                    else { setError("LỖI: KHỞI TẠO PILOT THẤT BẠI"); }
                } finally { setIsLoading(false); }
            };

            if (booting) {
                return (
                    <div className="min-h-screen bg-black flex items-center justify-center">
                        <div className="w-full max-w-2xl p-4">
                            {bootLines.map((line, i) => <p key={i} className="text-lg">> {line}</p>)}
                            <span className="typing-cursor"></span>
                        </div>
                    </div>
                );
            }

            return (
                 <div className="min-h-screen flex flex-col items-center justify-center p-4" style={{animation: 'fadeIn 1s forwards'}}>
                    <div className="w-full max-w-md p-4 sm:p-8 space-y-4 retro-container">
                        <h2 className="text-3xl sm:text-4xl text-center glitch-text">AQUARIUS OS</h2>
                        <p className="text-center text-md sm:text-lg">> YÊU CẦU XÁC THỰC PILOT</p>
                        <div className="space-y-4">
                            <div>
                                <label className="text-md sm:text-lg">> MÃ HIỆU PILOT:</label>
                                <input value={username} onChange={e => setUsername(e.target.value)} type="text" required className="w-full mt-1 retro-input" />
                            </div>
                            <div>
                                <label className="text-md sm:text-lg">> MẬT KHẨU:</label>
                                <input value={password} onChange={e => setPassword(e.target.value)} type="password" required className="w-full mt-1 retro-input" />
                            </div>
                            {error && <div className="text-md sm:text-lg text-center py-2 bg-red-900 bg-opacity-50 border border-red-500">{error}<span className="typing-cursor"></span></div>}
                            <div className="flex items-center space-x-4">
                                <button onClick={handleLogin} disabled={isLoading} className="w-full retro-button">{isLoading ? 'ĐANG KẾT NỐI...' : 'KẾT NỐI'}</button>
                                <button onClick={handleSignup} disabled={isLoading} className="w-full retro-button">KHỞI TẠO</button>
                            </div>
                        </div>
                        <div className="text-center pt-4 border-t border-green-900">
                            <a href="https://t.me/longbaoF168" target="_blank" rel="noopener noreferrer" className="retro-button">LIÊN HỆ LONG BẢO</a>
                        </div>
                    </div>
                </div>
            );
        };
        
        //================================================================================
        // COMPONENT: AdminDashboard
        //================================================================================
        const AdminDashboard = ({ currentUser, onLogout }) => {
            const [conversations, setConversations] = useState([]);
            const [currentChat, setCurrentChat] = useState(null);
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [onlineCount, setOnlineCount] = useState(0);
            const [tableAlertInput, setTableAlertInput] = useState('');
            const messagesListRef = useRef(null);
            let unsubscribeMessages = useRef(null);

            useEffect(() => {
                const convRef = db.collection('user_chats').orderBy('lastUpdate', 'desc');
                const unsubConv = convRef.onSnapshot(snapshot => setConversations(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))), console.error);
                
                const statusRef = rtdb.ref('status');
                const unsubStatus = statusRef.on('value', snapshot => {
                    const statuses = snapshot.val() || {};
                    const count = Object.values(statuses).filter(s => s.isOnline).length;
                    setOnlineCount(count);
                });

                return () => { unsubConv(); unsubStatus(); };
            }, []);
            
            useEffect(() => {
                if (messagesListRef.current) messagesListRef.current.scrollTop = messagesListRef.current.scrollHeight;
            }, [messages]);

            const loadConversation = (conv) => {
                setCurrentChat(conv);
                if (unsubscribeMessages.current) unsubscribeMessages.current();
                const messagesRef = db.collection('user_chats').doc(conv.id).collection('messages').orderBy('timestamp');
                unsubscribeMessages.current = messagesRef.onSnapshot(snapshot => {
                    setMessages(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, console.error);
            };

            const handleSendMessage = async () => {
                if (inputMessage.trim() === '' || !currentChat) return;
                await db.collection(`user_chats/${currentChat.id}/messages`).add({
                    type: 'text',
                    text: inputMessage,
                    senderId: currentUser.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                setInputMessage('');
            };

            const handleQuickReply = async (text) => {
                if (!currentChat) return;
                soundService.playSend();
                await db.collection(`user_chats/${currentChat.id}/messages`).add({
                    type: 'text',
                    text: text,
                    senderId: currentUser.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            };

            const handleSendGlobalAlert = async () => {
                if (tableAlertInput.trim() === '') return;
                soundService.playAlert();
                await db.collection('global_alerts').add({
                    table: tableAlertInput.trim(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                });
                setTableAlertInput('');
            };
            
            const AsciiChart = ({ value, total }) => {
                const percentage = total > 0 ? (value / total) * 100 : 0;
                const filledChars = Math.round((percentage / 100) * 20);
                const emptyChars = 20 - filledChars;
                const bar = `[${'█'.repeat(filledChars)}${'░'.repeat(emptyChars)}]`;
                return <pre className="text-sm">{bar} {value}/{total} ONLINE</pre>;
            };

            return (
                <div className="flex w-full h-screen p-1 sm:p-2 md:p-4">
                    <aside className={`w-full md:w-1/3 lg:w-1/4 retro-container flex-col ${currentChat ? 'hidden md:flex' : 'flex'}`}>
                        <header className="retro-header flex justify-between items-center flex-shrink-0">
                            <h2 className="text-lg sm:text-xl glitch-text">ĐIỀU KHIỂN</h2>
                            <button onClick={onLogout} className="text-xs retro-button">ĐĂNG XUẤT</button>
                        </header>
                         <div className="p-2 border-b border-green-900">
                            <p className="text-md sm:text-lg">TRẠNG THÁI</p>
                            <AsciiChart value={onlineCount} total={conversations.length} />
                        </div>
                        <div className="flex-1 overflow-y-auto">
                            {conversations.map(conv => (
                                <div key={conv.id} onClick={() => loadConversation(conv)} className={`p-3 border-b border-green-900 cursor-pointer hover:bg-green-900 bg-opacity-50 ${currentChat?.id === conv.id ? 'bg-green-800' : ''}`}>
                                    <p className="font-semibold text-md sm:text-lg truncate">> {conv.username || 'Unknown'}</p>
                                </div>
                            ))}
                        </div>
                    </aside>
                    <section className={`w-full md:w-2/3 lg:w-3/4 flex-col retro-container ml-0 md:ml-2 ${currentChat ? 'flex' : 'hidden md:flex'}`}>
                        {currentChat ? (
                            <React.Fragment>
                                <header className="retro-header flex items-center">
                                    <button onClick={() => setCurrentChat(null)} className="md:hidden mr-4 retro-button text-sm p-2">&lt;</button>
                                    > KÊNH: {currentChat.username}
                                </header>
                                <main ref={messagesListRef} className="flex-1 p-2 sm:p-4 overflow-y-auto">
                                    {messages.map(msg => (
                                        <div key={msg.id} className={`flex mb-4 ${msg.senderId === currentUser.uid ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-lg p-2 ${msg.senderId === currentUser.uid ? 'text-cyan-300' : ''}`}><MessageContent msg={msg}/></div>
                                        </div>
                                    ))}
                                </main>
                                <footer className="p-2 sm:p-4 border-t border-green-900">
                                    <div className="flex items-center border border-red-500 p-2 mb-2">
                                        <input value={tableAlertInput} onChange={e => setTableAlertInput(e.target.value)} className="flex-1 retro-input text-sm" placeholder="> BÀN CẢNH BÁO..." />
                                        <button onClick={handleSendGlobalAlert} className="ml-2 retro-button border-red-500 text-red-400 hover:bg-red-500 hover:text-black text-sm">GỬI</button>
                                    </div>
                                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-2">
                                        <button onClick={() => handleQuickReply('NHÀ CON')} className="retro-button text-sm">NHÀ CON</button>
                                        <button onClick={() => handleQuickReply('NHÀ CÁI')} className="retro-button text-sm">NHÀ CÁI</button>
                                        <button onClick={() => handleQuickReply('LONG BẢO')} className="retro-button text-sm">LONG BẢO</button>
                                        <button onClick={() => handleQuickReply('XIN VUI LÒNG ĐỢI')} className="retro-button text-sm">XIN VUI LÒNG ĐỢI</button>
                                    </div>
                                    <div className="flex items-center">
                                        <input value={inputMessage} onChange={e => setInputMessage(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleSendMessage()} className="flex-1 retro-input" placeholder="> Phản hồi..." />
                                        <button onClick={handleSendMessage} className="ml-2 retro-button">GỬI</button>
                                    </div>
                                </footer>
                            </React.Fragment>
                        ) : (
                            <div className="flex-1 flex items-center justify-center opacity-50 text-xl">> CHỌN KÊNH LIÊN LẠC</div>
                        )}
                    </section>
                </div>
            );
        };

        //================================================================================
        // COMPONENT: UserView
        //================================================================================
        const UserView = ({ currentUser, onLogout }) => {
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [energy, setEnergy] = useState(7);
            const [showBlessingModal, setShowBlessingModal] = useState(false);
            const [plea, setPlea] = useState('');
            const [cooldownTimeLeft, setCooldownTimeLeft] = useState(0);
            const [lastBlessingTime, setLastBlessingTime] = useState(null);
            const [showInfoModal, setShowInfoModal] = useState(false);
            const [infoFormData, setInfoFormData] = useState({ f168Account: '', capital: '', target: '' });
            const messagesListRef = useRef(null);

            useEffect(() => {
                if (!currentUser) return;
                const userDocRef = db.collection('users').doc(currentUser.uid);
                const unsubUser = userDocRef.onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        setLastBlessingTime(data.lastBlessingTimestamp?.toMillis() || null);
                        setEnergy(data.energy !== undefined ? data.energy : 7);
                        if (data.hasSubmittedInfo !== true) {
                            setShowInfoModal(true);
                        }
                    }
                });

                const messagesRef = db.collection('user_chats').doc(currentUser.uid).collection('messages').orderBy('timestamp');
                const unsubMessages = messagesRef.onSnapshot(snapshot => {
                    setMessages(prevMessages => {
                        const newMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (prevMessages.length > 0 && newMessages.length > prevMessages.length && newMessages[newMessages.length-1].senderId !== currentUser.uid) {
                            soundService.playReceive();
                        }
                        return newMessages;
                    });
                }, console.error);
                
                return () => { unsubUser(); unsubMessages(); };
            }, [currentUser]);

            useEffect(() => {
                const timer = setInterval(() => {
                    if (lastBlessingTime) {
                        const timeLeft = (lastBlessingTime + COOLDOWN_DURATION) - Date.now();
                        setCooldownTimeLeft(timeLeft > 0 ? timeLeft : 0);
                    }
                }, 1000);
                return () => clearInterval(timer);
            }, [lastBlessingTime]);

            useEffect(() => {
                 if (messagesListRef.current) messagesListRef.current.scrollTop = messagesListRef.current.scrollHeight;
            }, [messages]);

            const sendMessage = async (type, data, cost = 0) => {
                const userDocRef = db.collection('users').doc(currentUser.uid);
                const messagesPath = `user_chats/${currentUser.uid}/messages`;

                try {
                    await db.runTransaction(async (transaction) => {
                        const userDoc = await transaction.get(userDocRef);
                        if (!userDoc.exists) { throw "User document does not exist!"; }

                        const currentEnergy = userDoc.data().energy || 0;
                        if (currentEnergy < cost) { throw "Not enough energy!"; }

                        if (cost > 0) {
                            transaction.update(userDocRef, { energy: firebase.firestore.FieldValue.increment(-cost) });
                        }

                        const messageData = { type, senderId: currentUser.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
                        if (type === 'text' || type === 'plea') messageData.text = data;
                        else messageData.content = data;
                        
                        const newMessageRef = db.collection(messagesPath).doc();
                        transaction.set(newMessageRef, messageData);
                    });
                    soundService.playSend();
                } catch (error) {
                    console.error("Transaction failed: ", error);
                    if (error === "Not enough energy!") { alert("NĂNG LƯỢNG KHÔNG ĐỦ!"); } 
                    else { alert("LỖI: KHÔNG THỂ GỬI TIN NHẮN."); }
                    soundService.playError();
                }
            };

            const handleSendMessage = async () => {
                const content = inputMessage.trim();
                if (content === '') return;
                await sendMessage('text', content, MESSAGE_COST);
                setInputMessage('');
            };

            const handleBlessingRequest = async () => {
                if (plea.trim() === '') return;
                setShowBlessingModal(false);
                await sendMessage('plea', plea.trim());
                
                const blessing = {
                    table: BACARAT_TABLES[Math.floor(Math.random() * BACARAT_TABLES.length)],
                    side: Math.random() < 0.5 ? 'NHÀ CON' : 'NHÀ CÁI',
                    hand: Math.floor(Math.random() * (30 - 15 + 1)) + 15
                };
                
                setTimeout(async () => {
                    const blessingMessage = {
                        type: 'blessing',
                        content: blessing,
                        senderId: 'AQUARIUS_SYSTEM',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await db.collection(`user_chats/${currentUser.uid}/messages`).add(blessingMessage);
                    await db.collection('users').doc(currentUser.uid).set({
                        lastBlessingTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                }, 1500);

                setPlea('');
            };
            
            const handleInfoSubmit = async () => {
                const { f168Account, capital, target } = infoFormData;
                if (!f168Account || !capital || !target) {
                    alert("VUI LÒNG NHẬP ĐẦY ĐỦ THÔNG TIN");
                    return;
                }
                const infoContent = { f168Account, capital, target };
                await sendMessage('info_submission', infoContent);
                await db.collection('users').doc(currentUser.uid).set({ hasSubmittedInfo: true }, { merge: true });
                setShowInfoModal(false);
            };

            const formatTime = (ms) => {
                if (ms <= 0) return "00:00:00";
                const totalSeconds = Math.floor(ms / 1000);
                const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
                const seconds = (totalSeconds % 60).toString().padStart(2, '0');
                return `${hours}:${minutes}:${seconds}`;
            };

            const EnergyBar = ({ value }) => {
                const percentage = Math.max(0, Math.min(100, (value / 7) * 100));
                const barColor = percentage > 50 ? 'bg-green-500' : percentage > 20 ? 'bg-yellow-500' : 'bg-red-500';
                const barWidth = `${percentage}%`;
                return (
                    <div className="w-full border border-green-700 p-1">
                        <div className="flex items-center">
                            <div className="text-xs sm:text-sm mr-2">N.LƯỢNG:</div>
                            <div className="flex-1 h-4 bg-gray-800">
                                <div className={`h-full ${barColor}`} style={{width: barWidth}}></div>
                            </div>
                            <div className="text-sm ml-2">{value}</div>
                        </div>
                    </div>
                );
            };

            const username = currentUser.email.split('@')[0];

            return (
                 <div className="h-screen p-1 sm:p-2 md:p-4">
                    <div className="w-full h-full flex flex-col retro-container crt-effect">
                        <header className="retro-header flex justify-between items-center">
                            <h2 className="text-lg sm:text-xl glitch-text">AQUARIUS TERMINAL</h2>
                            <button onClick={() => { soundService.playClick(); onLogout(); }} className="text-xs retro-button p-2">NGẮT KẾT NỐI</button>
                        </header>
                        <div className="p-2 border-b border-green-900">
                            <p className="truncate">> PILOT: {username}</p>
                            <EnergyBar value={energy} />
                        </div>
                        <main ref={messagesListRef} className="flex-1 p-2 sm:p-4 overflow-y-auto">
                            {messages.map((msg) => (
                                <div key={msg.id} className="mb-2">
                                    <div className={msg.senderId === currentUser.uid ? 'text-cyan-300' : ''}>
                                        {msg.type === 'system' ? '' : <span className="mr-2">{msg.senderId === currentUser.uid ? `<${username}>` : '<AQUARIUS>'}</span>}
                                        {msg.type === 'blessing' ? <TypingMessage text={JSON.stringify(msg.content, null, 2)} /> : <MessageContent msg={msg} />}
                                    </div>
                                </div>
                            ))}
                        </main>
                        <div className="p-2 border-t border-b border-green-900 flex justify-around items-center space-x-2 relative">
                            {cooldownTimeLeft > 0 ? (
                                <div className="text-center text-xs">
                                    <p className="opacity-70">HỒI CHIÊU</p>
                                    <p className="text-sm sm:text-lg">{formatTime(cooldownTimeLeft)}</p>
                                </div>
                            ) : (
                                <button onClick={() => {soundService.playClick(); setShowBlessingModal(true);}} className="retro-button text-xs sm:text-sm p-2">[BAN PHƯỚC]</button>
                            )}
                            <button onClick={() => {soundService.playClick(); alert('TÀI KHOẢN CỦA BẠN KHÔNG ĐỦ ĐIỀU KIỆN! HÃY CHƠI ĐỀU VÀ LÊN VIP');}} className="retro-button text-xs sm:text-sm p-2">[ỨNG TIỀN]</button>
                        </div>
                        <footer className="p-2 border-t border-green-900">
                            <div className="flex w-full items-center">
                                <span className="mr-2 text-lg">></span>
                                <input className="flex-1 retro-input" placeholder="Nhập lệnh..." value={inputMessage} onChange={(e) => {setInputMessage(e.target.value); soundService.playTyping();}} onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), handleSendMessage())} />
                                <button onClick={handleSendMessage} disabled={energy < MESSAGE_COST} className="ml-2 retro-button p-2">GỬI</button>
                            </div>
                        </footer>
                    </div>
                    {showBlessingModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
                            <div className="p-6 retro-container w-full max-w-sm" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl sm:text-2xl glitch-text mb-4">TRUYỀN TẢI THỈNH CẦU</h3>
                                <textarea value={plea} onChange={e => setPlea(e.target.value)} className="w-full h-24 retro-textarea" placeholder="> Viết lời thỉnh cầu của bạn tại đây..."></textarea>
                                <div className="flex justify-end space-x-4 mt-4">
                                    <button onClick={() => {soundService.playClick(); setShowBlessingModal(false);}} className="retro-button">HỦY</button>
                                    <button onClick={() => {soundService.playClick(); handleBlessingRequest();}} className="retro-button">GỬI</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showInfoModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
                            <div className="p-6 retro-container w-full max-w-sm" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl sm:text-2xl glitch-text mb-4">YÊU CẦU KHAI BÁO</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-md sm:text-lg">> TÊN TK F168:</label>
                                        <input value={infoFormData.f168Account} onChange={e => setInfoFormData({...infoFormData, f168Account: e.target.value})} type="text" className="w-full mt-1 retro-input" />
                                    </div>
                                    <div>
                                        <label className="text-md sm:text-lg">> SỐ VỐN:</label>
                                        <input value={infoFormData.capital} onChange={e => setInfoFormData({...infoFormData, capital: e.target.value})} type="text" className="w-full mt-1 retro-input" />
                                    </div>
                                     <div>
                                        <label className="text-md sm:text-lg">> MUỐN LÊN BAO NHIÊU:</label>
                                        <input value={infoFormData.target} onChange={e => setInfoFormData({...infoFormData, target: e.target.value})} type="text" className="w-full mt-1 retro-input" />
                                    </div>
                                </div>
                                <div className="flex justify-end mt-6">
                                    <button onClick={() => {soundService.playClick(); handleInfoSubmit();}} className="retro-button">GỬI BÁO CÁO</button>
                                </div>
                            </div>
                        </div>
                    )}
                 </div>
            );
        };

        // NEW: Component for the global alert banner
        const GlobalAlertBanner = ({ alert }) => {
            if (!alert) return null;
            return (
                <div className="fixed top-0 left-0 w-full bg-red-800 bg-opacity-90 border-b-2 border-red-500 text-white p-3 text-center z-[10000] text-lg sm:text-2xl glitch-text">
                    !!! CẢNH BÁO: TẬP TRUNG TẠI BÀN {alert.table} !!!
                </div>
            );
        };
        
        //================================================================================
        // TOP-LEVEL COMPONENT: System
        //================================================================================
        const System = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [isAdmin, setIsAdmin] = useState(false);
            const [activeAlert, setActiveAlert] = useState(null);

            useEffect(() => {
                const startAudio = () => {
                    soundService.init();
                    soundService.startAmbient();
                    document.removeEventListener('click', startAudio);
                    document.removeEventListener('keydown', startAudio);
                };
                document.addEventListener('click', startAudio);
                document.addEventListener('keydown', startAudio);

                const unsubscribeAuth = auth.onAuthStateChanged(user => {
                    setCurrentUser(user);
                    setIsAdmin(user ? user.email.split('@')[0] === ADMIN_USERNAME : false);
                    setIsLoading(false);
                    if (user) {
                        const userStatusRef = rtdb.ref('/status/' + user.uid);
                        const isOnline = { isOnline: true, lastSeen: firebase.database.ServerValue.TIMESTAMP };
                        const isOffline = { isOnline: false, lastSeen: firebase.database.ServerValue.TIMESTAMP };
                        rtdb.ref('.info/connected').on('value', snapshot => {
                            if (snapshot.val() === false) return;
                            userStatusRef.onDisconnect().set(isOffline).then(() => userStatusRef.set(isOnline));
                        });
                    }
                });

                const q = db.collection('global_alerts').orderBy('timestamp', 'desc').limit(1);
                const unsubscribeAlerts = q.onSnapshot(snapshot => {
                    if (!snapshot.empty) {
                        const alertData = snapshot.docs[0].data();
                        const alertTimestamp = alertData.timestamp;
                        if (alertTimestamp && (Date.now() - alertTimestamp.toMillis() < 15000)) {
                            setActiveAlert(alertData);
                            soundService.playAlert();
                            const timer = setTimeout(() => setActiveAlert(null), 8000);
                            return () => clearTimeout(timer);
                        }
                    }
                });

                return () => {
                    unsubscribeAuth();
                    unsubscribeAlerts();
                    document.removeEventListener('click', startAudio);
                    document.removeEventListener('keydown', startAudio);
                };
            }, []);

            const handleLogout = () => {
                if (auth.currentUser) {
                    rtdb.ref('/status/' + auth.currentUser.uid).set({
                        isOnline: false,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                auth.signOut();
            };
            
            return (
                <div className={activeAlert ? 'red-alert-flash' : ''}>
                    <GlobalAlertBanner alert={activeAlert} />
                    <Starfield />
                    {isLoading ? (
                        <div className="min-h-screen bg-black flex items-center justify-center text-2xl animate-pulse"><p>ĐANG KHỞI ĐỘNG HỆ THỐNG...<span className="typing-cursor"></span></p></div>
                    ) : !currentUser ? (
                        <LoginScreen />
                    ) : isAdmin ? (
                        <AdminDashboard currentUser={currentUser} onLogout={handleLogout} />
                    ) : (
                        <UserView currentUser={currentUser} onLogout={handleLogout} />
                    )}
                </div>
            );
        };

        ReactDOM.render(<System />, document.getElementById('root'));
    </script>
</body>
</html>
